<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Russell Properties</title>
    <link rel="stylesheet" href="/public/styles/main.css" />
    <style>
      /* TABLE STYLES */
      .table-responsive {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: auto;
        margin-bottom: 2rem;
        border: 1px solid var(--primary-color, #333);
      }

      .table-responsive table {
        width: 100%;
        border-collapse: collapse;
      }

      .table-responsive thead {
        position: sticky;
        top: 0;
        background-color: var(--primary-color, #333);
        color: var(--secondary-color, #fff);
        z-index: 2;
      }

      th, td {
        border: 1px solid var(--primary-color, #333);
        padding: 12px;
        text-align: left;
      }

      th {
        background-color: var(--primary-color, #333);
        color: var(--secondary-color, #fff);
      }

      tbody tr:nth-child(even) {
        background-color: var(--secondary-color, #f9f9f9);
      }

      tbody tr:hover {
        background-color: rgba(231, 76, 60, 0.2);
      }

      /* Search Bar Styles */
      .search-bar {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }

      /* Form and Button Styles */
      .edit-btn, .delete-btn {
        cursor: pointer;
        padding: 5px 10px;
        border: none;
        color: white;
      }

      .edit-btn {
        background-color: #f39c12;
      }

      .delete-btn {
        background-color: #e74c3c;
      }

      form {
        margin-top: 1rem;
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      form input, form select {
        padding: 8px;
        flex: 1 1 200px;
      }

      form button {
        background-color: var(--primary-color, #333);
        color: var(--secondary-color, #fff);
        border: none;
        padding: 10px 20px;
        cursor: pointer;
      }

      .info-button {
        display: inline-block;
        padding: 10px 15px;
        border: 2px solid #333;
        border-radius: 5px;
        background-color: #f8f9fa;
        color: #333;
        text-decoration: none;
        font-weight: bold;
      }

      .info-button:hover {
        background-color: #ddd;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import { createHeader } from '/components/header.js';
      import { createFooter } from '/components/footer.js';
      import { requireAuth } from '/scripts/auth.js';

      document.body.prepend(createHeader());
      document.body.appendChild(createFooter());
      requireAuth('manager');
    </script>

    <header>
      <div class="container">
        <h1>Admin Dashboard</h1>
        <nav>
          <ul>
            <li>
              <a href="/maintenance-info" class="info-button">Check ALL Maintenance Requests</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container">
      <!-- PROPERTIES SECTION -->
      <h2>Add New Property</h2>
      <form id="add-property-form">
        <input type="text" id="property_address" placeholder="Address" required />
        <input type="text" id="property_city" placeholder="City" required />
        <input type="text" id="property_state" placeholder="State" required />
        <input type="text" id="property_postal_code" placeholder="Postal Code" required />
        <input type="number" id="property_num_apartments" placeholder="Number of Apartments" required />
        <button type="submit">Add Property</button>
      </form>

      <input type="text" id="search-property" placeholder="Search properties..." class="search-bar">
      <div class="table-responsive">
        <table id="property-table">
          <thead>
            <tr>
              <th>Property ID</th>
              <th>Address</th>
              <th>City</th>
              <th>State</th>
              <th>Postal Code</th>
              <th>Number of Apartments</th>
              <th>Available</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr id="no-properties-message">
              <td colspan="6">Loading properties...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- APARTMENTS SECTION -->
      <h2>Add New Apartment</h2>
      <form id="add-apartment-form">
        <input type="number" id="apartment_property_id" placeholder="Property ID" required />
        <input type="text" id="apartment_unit_number" placeholder="Unit Number" required />
        <input type="number" id="apartment_floor" placeholder="Floor" required />
        <input type="number" id="apartment_bedrooms" placeholder="Bedrooms" step="0.5" required />
        <input type="number" id="apartment_bathrooms" placeholder="Bathrooms" step="0.5" required />
        <input type="number" id="apartment_square_footage" placeholder="Square Footage" required />
        <input type="number" id="apartment_rent_amount" placeholder="Rent Amount" required />
        <button type="submit">Add Apartment</button>
      </form>

      <input type="text" id="search-apartment" placeholder="Search apartments..." class="search-bar">
      <div class="table-responsive">
        <table id="apartment-table">
          <thead>
            <tr>
              <th>Apartment ID</th>
              <th>Property ID</th>
              <th>Unit Number</th>
              <th>Floor</th>
              <th>Bedrooms</th>
              <th>Bathrooms</th>
              <th>Square Footage</th>
              <th>Rent Amount</th>
              <th>Available</th>
              <th>Actions</th>
            </tr>
          </thead>
          
          <tbody>
            <tr id="no-apartments-message">
              <td colspan="9">Loading apartments...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- USERS SECTION -->
      <h2>Add New User</h2>
      <form id="add-user-form">
        <input type="text" id="user_username" placeholder="Username" required />
        <input type="number" id="user_property_id" placeholder="Property ID" required />
        <input type="text" id="user_role" placeholder="Role" required />
        <input type="text" id="user_phone_number" placeholder="Phone Number" required />
        <input type="password" id="user_password" placeholder="Password" required />
        <input type="text" id="user_mfa_secret" placeholder="MFA Secret (optional)" />
        <button type="submit">Add User</button>
      </form>

      <input type="text" id="search-user" placeholder="Search users..." class="search-bar">
      <div class="table-responsive">
        <table id="user-table">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Property ID</th>
              <th>Role</th>
              <th>Username</th>
              <th>Password</th>
              <th>Phone Number</th>
              <th>MFA Secret</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr id="no-users-message">
              <td colspan="8">Loading users...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2025 Russell Properties LLC. All rights reserved.</p>
      </div>
    </footer>

    <script>
      // SEARCH FUNCTIONALITY
      function setupSearch(inputId, tableId) {
        const searchInput = document.getElementById(inputId);
        const table = document.getElementById(tableId);
        
        searchInput.addEventListener('input', function() {
          const filter = this.value.toLowerCase();
          const rows = table.querySelectorAll('tbody tr');
          
          rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let matches = false;
            cells.forEach(cell => {
              if (cell.textContent.toLowerCase().includes(filter)) {
                matches = true;
              }
            });
            row.style.display = matches ? '' : 'none';
          });
        });
      }

      // PROPERTIES CRUD
      document.addEventListener('DOMContentLoaded', async function() {
        const propertyForm = document.getElementById('add-property-form');
        const propertyTableBody = document.querySelector('#property-table tbody');
        const noPropertiesMessage = document.getElementById('no-properties-message');

        async function loadProperties() {
          try {
            const response = await fetch('/api/assets');
            const properties = await response.json();
            propertyTableBody.innerHTML = '';
            
            if (properties.length === 0) {
              noPropertiesMessage.style.display = 'block';
            } else {
              noPropertiesMessage.style.display = 'none';
              properties.forEach(property => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${property.property_id}</td>
                <td contenteditable="true">${property.address}</td>
                <td contenteditable="true">${property.city}</td>
                <td contenteditable="true">${property.state}</td>
                <td contenteditable="true">${property.postal_code}</td>
                <td contenteditable="true">${property.num_apartments}</td>
                <td>
                  <input type="checkbox" class="toggle-availability" data-id="${property.property_id}" ${property.is_available ? 'checked' : ''}>
                </td>
                <td>
                  <button class="edit-btn" data-id="${property.property_id}">Save</button>
                  <button class="delete-btn" data-id="${property.property_id}">Delete</button>
                </td>
              `;

                propertyTableBody.appendChild(row);
              });
            }
          } catch (error) {
            console.error('Error loading properties:', error);
          }
        }

        propertyForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = {
            address: document.getElementById('property_address').value,
            city: document.getElementById('property_city').value,
            state: document.getElementById('property_state').value,
            postal_code: document.getElementById('property_postal_code').value,
            num_apartments: document.getElementById('property_num_apartments').value
          };

          try {
            await fetch('/api/assets', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            loadProperties();
          } catch (error) {
            console.error('Error adding property:', error);
          }
        });

        // Load initial data
        loadProperties();
      });

      // APARTMENTS CRUD
      document.addEventListener('DOMContentLoaded', async function() {
        const apartmentForm = document.getElementById('add-apartment-form');
        const apartmentTableBody = document.querySelector('#apartment-table tbody');
        const noApartmentsMessage = document.getElementById('no-apartments-message');

        async function loadApartments() {
          try {
            const response = await fetch('/api/apartments');
            const apartments = await response.json();
            apartmentTableBody.innerHTML = '';
            
            if (apartments.length === 0) {
              noApartmentsMessage.style.display = 'block';
            } else {
              noApartmentsMessage.style.display = 'none';
              apartments.forEach(apartment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${apartment.apartment_id}</td>
                <td contenteditable="true">${apartment.property_id}</td>
                <td contenteditable="true">${apartment.unit_number}</td>
                <td contenteditable="true">${apartment.floor}</td>
                <td contenteditable="true">${apartment.bedrooms}</td>
                <td contenteditable="true">${apartment.bathrooms}</td>
                <td contenteditable="true">${apartment.square_footage}</td>
                <td contenteditable="true">${apartment.rent_amount}</td>
                <td>
                  <input type="checkbox" class="toggle-availability" data-id="${apartment.apartment_id}" ${apartment.is_available ? 'checked' : ''}>
                </td>
                <td>
                  <button class="edit-btn" data-id="${apartment.apartment_id}">Save</button>
                  <button class="delete-btn" data-id="${apartment.apartment_id}">Delete</button>
                </td>
              `;

                apartmentTableBody.appendChild(row);
              });
            }
          } catch (error) {
            console.error('Error loading apartments:', error);
          }
        }

        apartmentForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = {
            property_id: document.getElementById('apartment_property_id').value,
            unit_number: document.getElementById('apartment_unit_number').value,
            floor: document.getElementById('apartment_floor').value,
            bedrooms: document.getElementById('apartment_bedrooms').value,
            bathrooms: document.getElementById('apartment_bathrooms').value,
            square_footage: document.getElementById('apartment_square_footage').value,
            rent_amount: document.getElementById('apartment_rent_amount').value
          };

          try {
            await fetch('/api/apartments', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            loadApartments();
          } catch (error) {
            console.error('Error adding apartment:', error);
          }
        });

        loadApartments();
      });

      // USERS CRUD
      document.addEventListener('DOMContentLoaded', async function() {
        const userForm = document.getElementById('add-user-form');
        const userTableBody = document.querySelector('#user-table tbody');
        const noUsersMessage = document.getElementById('no-users-message');

        async function loadUsers() {
          try {
            const response = await fetch('/api/users');
            const users = await response.json();
            userTableBody.innerHTML = '';
            
            if (users.length === 0) {
              noUsersMessage.style.display = 'block';
            } else {
              noUsersMessage.style.display = 'none';
              users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${user.user_id}</td>
                  <td contenteditable="true">${user.property_id}</td>
                  <td contenteditable="true">${user.role}</td>
                  <td contenteditable="true">${user.username}</td>
                  <td contenteditable="true">${user.password}</td>
                  <td contenteditable="true">${user.phone_number}</td>
                  <td contenteditable="true">${user.mfa_secret || ''}</td>
                  <td>
                    <button class="edit-btn" data-id="${user.user_id}">Save</button>
                    <button class="delete-btn" data-id="${user.user_id}">Delete</button>
                  </td>
                `;
                userTableBody.appendChild(row);
              });
            }
          } catch (error) {
            console.error('Error loading users:', error);
          }
        }

        userForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = {
            username: document.getElementById('user_username').value,
            property_id: document.getElementById('user_property_id').value,
            role: document.getElementById('user_role').value,
            phone_number: document.getElementById('user_phone_number').value,
            password: document.getElementById('user_password').value,
            mfa_secret: document.getElementById('user_mfa_secret').value
          };

          try {
            await fetch('/api/users', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            loadUsers();
          } catch (error) {
            console.error('Error adding user:', error);
          }
        });

        // Initialize search and data
        document.addEventListener('DOMContentLoaded', function() {
          setupSearch('search-property', 'property-table');
          setupSearch('search-apartment', 'apartment-table');
          setupSearch('search-user', 'user-table');
          loadUsers();
        });
      });
      document.addEventListener('change', async (event) => {
    if (event.target.classList.contains('toggle-availability')) {
        const id = event.target.getAttribute('data-id');
        const isAvailable = event.target.checked;

        const endpoint = event.target.closest('tr').querySelector('td:first-child').textContent.includes('P')
            ? `/api/assets/${id}`
            : `/api/apartments/${id}`;

        try {
            await fetch(endpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_available: isAvailable })
            });
            console.log(`Availability updated for ID ${id}`);
        } catch (error) {
            console.error('Error updating availability:', error);
        }
    }
});

    </script>
  </body>
</html>