<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <link
      rel="stylesheet"
      href="/public/styles/main.css"
    />
    <title>Login - Russell Properties</title>
  </head>
  <body>
    <script type="module">
      import { createHeader } from '/components/header.js';
      import { createFooter } from '/components/footer.js';
      document.body.prepend(createHeader());
      document.body.appendChild(createFooter());
    </script>

    <main>
      <section id="login">
        <div class="container">
          <h2>Login</h2>
          <form id="loginForm">
            <label for="username">Username:</label>
            <input
              type="text"
              id="username"
              name="username"
              required
            />

            <label for="password">Password:</label>
            <input
              type="password"
              id="password"
              name="password"
              required
            />

            <button type="submit">Login</button>
            <p
              id="errorMessage"
              style="color: red; display: none"
            ></p>
            <p
              id="successMessage"
              style="color: green; display: none"
            ></p>
          </form>
          <p>
            <a href="/register">Create an account</a> |
            <a href="/forgot_password">Forgot your password?</a>
          </p>
        </div>
      </section>
      <section>
        <div class="container">
          <h2>Test Accounts</h2>
          <p>
            Use the following test accounts to log in and explore the website:
          </p>
          <ul>
            <li>Manager: manager1 / password1</li>
            <li>Agent: maintenance1 / password2</li>
            <li>Client: tenant1 / password3</li>
          </ul>
        </div>
      </section>
    </main>

    <script>
      document
        .getElementById('loginForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault(); // Prevent form submission

          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value.trim();
          const errorMessage = document.getElementById('errorMessage');
          const successMessage = document.getElementById('successMessage');

          // Clear previous messages
          errorMessage.style.display = 'none';
          errorMessage.textContent = '';
          successMessage.style.display = 'none';
          successMessage.textContent = '';

          if (!username || !password) {
            errorMessage.textContent = 'Username and password are required.';
            errorMessage.style.display = 'block';
            return;
          }

          try {
            console.log('Attempting to log in with:', { username, password });

            // Send login request to the server
            const response = await fetch('/api/users/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password }),
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(errorText || 'Invalid username or password');
            }

            const result = await response.json();
            console.log('Login result:', result);

            // Save login state with persistent storage
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.setItem('role', result.role);
            localStorage.setItem('user_id', result.user_id);

            // Display success message instead of redirecting
            successMessage.textContent = 'Login success!';
            successMessage.style.display = 'block';

            // Redirect to the user dashboard
            window.location.href = '/index';
          } catch (error) {
            console.error('Login Error:', error);
            errorMessage.textContent =
              'An error occurred. Please try again later.';
            errorMessage.style.display = 'block';
          }
        });
    </script>
  </body>
</html>
