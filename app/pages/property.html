<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <link
      rel="icon"
      href="/public/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="/public/styles/main.css"
    />
    <title>Property Details - Russell Properties</title>
    <style>
      /* Basic styling for details and carousels */
      #property-details {
        margin: 20px;
      }
      .carousel-container {
        margin: 20px 0;
      }
      .carousel-container h2 {
        margin-bottom: 10px;
      }
      .carousel {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 10px;
      }
      .carousel img {
        width: 200px;
        height: auto;
        border: 1px solid #ddd;
      }
      /* Apartments list styling */
      #apartments ul {
        list-style: none;
        padding: 0;
      }
      #apartments li {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <!-- Documentation: This page fetches property details (by property_id), displays property images, and if available, lists apartments and their images -->
    <script type="module">
      import { createHeader } from '/components/header.js';
      import { createFooter } from '/components/footer.js';

      document.body.prepend(createHeader());
      document.body.appendChild(createFooter());
    </script>

    <!-- Main Content -->
    <main>
      <section id="property-details">
        <p>Loading property details...</p>
      </section>
    </main>

    <script>
      // Helper function to parse image URL fields
      // This function tries to parse the image_url field as JSON,
      // then cleans extraneous braces and splits comma-delimited URLs.
      function parseImageUrls(imageUrlField) {
        let urls = [];
        try {
          urls = JSON.parse(imageUrlField);
        } catch (parseError) {
          console.error("Error parsing image_url:", parseError);
          // Fallback: treat the field as a single URL string
          urls = [imageUrlField];
        }
        // Ensure we have an array
        if (!Array.isArray(urls)) {
          urls = [urls];
        }
        // Process each entry: remove extraneous braces and split by commas
        let finalUrls = [];
        urls.forEach(item => {
          let cleanedString = typeof item === "string"
            ? item.replace(/[{}]/g, "").trim()
            : "";
          let possibleUrls = cleanedString.split(",");
          possibleUrls.forEach(rawUrl => {
            let url = rawUrl.trim();
            if (url.startsWith("http://") || url.startsWith("https://")) {
              finalUrls.push(url);
            }
          });
        });
        return finalUrls;
      }

      // Function to load property (asset) images into the property images carousel
      async function loadPropertyImages(propertyId) {
        try {
          const response = await fetch(`/api/images?property_id=${propertyId}`, {
            headers: {
              "Content-Type": "application/json"
            }
          });
          if (!response.ok) throw new Error("Failed to fetch property images");
          const responseData = await response.json();
          const imageRecords = responseData.images || responseData;
          const container = document.getElementById("property-images-carousel");
          container.innerHTML = ""; // clear loading text

          if (!imageRecords || imageRecords.length === 0) {
            container.innerHTML = "<p>No property images available.</p>";
            return;
          }

          let appendedAtLeastOne = false;
          imageRecords.forEach(record => {
            const urls = parseImageUrls(record.image_url);
            urls.forEach(url => {
              const imgEl = document.createElement("img");
              imgEl.src = url;
              imgEl.alt = record.caption || "Property image";
              container.appendChild(imgEl);
              appendedAtLeastOne = true;
            });
          });

          if (!appendedAtLeastOne) {
            container.innerHTML = "<p>Property Images Coming Soon!</p>";
          }
        } catch (error) {
          console.error("Error loading property images:", error);
          const container = document.getElementById("property-images-carousel");
          container.innerHTML = "<p>Property Images Coming Soon!</p>";
        }
      }

      // Function to load apartment images into the corresponding carousel container for a given apartment_id
      async function loadApartmentImages(apartmentId) {
        try {
          const response = await fetch(`/api/images?apartment_id=${apartmentId}`, {
            headers: {
              "Content-Type": "application/json"
            }
          });
          if (!response.ok) throw new Error("Failed to fetch apartment images");
          const responseData = await response.json();
          const imageRecords = responseData.images || responseData;
          const container = document.getElementById(`apartment-carousel-${apartmentId}`);
          container.innerHTML = ""; // clear loading text

          if (!imageRecords || imageRecords.length === 0) {
            container.innerHTML = "<p>No images available for this apartment.</p>";
            return;
          }

          let appendedAtLeastOne = false;
          imageRecords.forEach(record => {
            const urls = parseImageUrls(record.image_url);
            urls.forEach(url => {
              const imgEl = document.createElement("img");
              imgEl.src = url;
              imgEl.alt = record.caption || "Apartment image";
              container.appendChild(imgEl);
              appendedAtLeastOne = true;
            });
          });

          if (!appendedAtLeastOne) {
            container.innerHTML = "<p>Apartment Images Coming Soon!</p>";
          }
        } catch (error) {
          console.error(`Error loading images for apartment ${apartmentId}:`, error);
          const container = document.getElementById(`apartment-carousel-${apartmentId}`);
          container.innerHTML = "<p>Apartment Images Coming Soon!</p>";
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        // Extract property_id from URL (assumes URL is like /property/123)
        const pathParts = window.location.pathname.split("/");
        const propertyId = pathParts[2];
        const detailsSection = document.querySelector("#property-details");

        try {
          // Fetch all properties and locate the one that matches propertyId
          const propertiesResponse = await fetch("/api/assets");
          if (!propertiesResponse.ok) throw new Error("Failed to fetch properties");
          const properties = await propertiesResponse.json();
          const property = properties.find(p => p.property_id == propertyId);

          if (!property) {
            detailsSection.innerHTML = `<p>⚠️ Property not found. Please return to <a href="/properties">Properties</a>.</p>`;
            return;
          }

          // Build the property details HTML
          let propertyHTML = `
            <h1>${property.address}</h1>
            <p>${property.city}, ${property.state} ${property.postal_code}</p>
            <p>${property.num_apartments} apartments</p>
            <div class="carousel-container">
              <h2>Property Images</h2>
              <div id="property-images-carousel" class="carousel">
                <p>Loading property images...</p>
              </div>
            </div>
          `;

          // Fetch apartments linked to this property
          const aptsResponse = await fetch(`/api/apartments/property/${propertyId}`);
          if (!aptsResponse.ok) throw new Error("Error fetching apartments");
          const apartments = await aptsResponse.json();

          // Filter apartments to only include those where is_available === 1
          const availableApartments = apartments.filter(a => a.is_available === 1);

          // If available apartments exist, build the apartments section
          if (availableApartments && availableApartments.length > 0) {
            propertyHTML += `<section id="apartments">
              <h2>Apartments</h2>
              <ul id="apartments-list">`;
            availableApartments.forEach(apartment => {
              propertyHTML += `
                <li>
                  <h3>Unit ${apartment.unit_number} (Floor ${apartment.floor})</h3>
                  <p>Bedrooms: ${apartment.bedrooms} | Bathrooms: ${apartment.bathrooms}</p>
                  <p>Square Footage: ${apartment.square_footage} sq ft</p>
                  <p>Rent: $${apartment.rent_amount}</p>
                  <div class="carousel-container">
                    <h4>Apartment Images</h4>
                    <div id="apartment-carousel-${apartment.apartment_id}" class="carousel">
                      <p>Loading apartment images...</p>
                    </div>
                  </div>
                </li>
              `;
            });
            propertyHTML += `</ul></section>`;
          }
          // If no available apartments, simply render the property details with its images

          // Render the assembled HTML into the details section
          detailsSection.innerHTML = propertyHTML;

          // Load property images carousel
          loadPropertyImages(propertyId);

          // For each available apartment, load its images
          if (availableApartments && availableApartments.length > 0) {
            availableApartments.forEach(apartment => {
              loadApartmentImages(apartment.apartment_id);
            });
          }
        } catch (error) {
          console.error(error);
          detailsSection.innerHTML = "<p>Property Details could not be loaded.</p>";
        }
      });
    </script>
  </body>
</html>
